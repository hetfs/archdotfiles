#!/usr/bin/env bash

# â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”
# â”‚ H â”‚ â”‚ E â”‚ â”‚ T â”‚ â”‚ F â”‚ â”‚ S â”‚
# â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜
# ===========================================================
# ðŸŒ HETFS LTD. Code for a Brighter Future
# https://github.com/hetfs/archdotfiles
# ===========================================================

# Interactive shells only
case $- in
*i*) ;;
*) return ;;
esac

# ===== Environment =====
export PATH="/usr/sbin:/usr/local/sbin:$HOME/.local/bin:$CARGO_HOME/bin:$GOPATH/bin:$NPM_CONFIG_PREFIX/bin:$TFENV/bin:$XDG_DATA_HOME/nvim/mason/bin:$PATH"
export NVM_DIR="$HOME/.config/nvm"
export MANPAGER='nvim --cmd ":lua vim.g.noplugins=1" +Man!'
export MANWIDTH=999
export EDITOR=nvim
export VISUAL=nvim
CDPATH="."

# ===== Shell Options =====
if [ -n "$BASH_VERSION" ]; then
  PS1='\n\w\n\$ '
  set -o noclobber
  shopt -s checkwinsize globstar nocaseglob histappend cmdhist autocd dirspell cdspell

  PROMPT_DIRTRIM=2

  bind Space:magic-space
  bind 'set completion-ignore-case on'
  bind 'set completion-map-case on'
  bind 'set show-all-if-ambiguous on'
  bind 'set mark-symlinked-directories on'

elif [ -n "$ZSH_VERSION" ]; then
  setopt append_history hist_ignore_dups share_history inc_append_history extended_history hist_ignore_space
fi

# ===== History =====
export HISTSIZE=100000
export HISTFILESIZE=100000
export HISTIGNORE="&:[ ]*:exit:ls:bg:fg:history:clear"
export HISTTIMEFORMAT='%F %T '

if [ -n "$BASH_VERSION" ]; then
  PROMPT_COMMAND='[ $? -eq 0 ] && { history -a; history -n; }'

  # Deduplicate history
  trap '
    [ -f "$HISTFILE" ] &&
    awk '\''!seen[$0]++'\'' "$HISTFILE" > "${HISTFILE}.tmp" &&
    mv "${HISTFILE}.tmp" "$HISTFILE"
  ' EXIT

  bind '"\e[A": history-search-backward'
  bind '"\e[B": history-search-forward'
fi

# ===== Aliases =====
alias c="clear"
alias cls="clear"
alias e="$EDITOR"
alias se="sudo $EDITOR"

alias cd..="cd ../"
alias rmrf="rm -rf"
alias psef="ps -ef"
alias vi="nvim"
alias vim="nvim"
alias nv="nvim"
alias cat="bat"
alias shell="exec \$SHELL -l"

alias mkdir="mkdir -p"
alias cp="cp -r"
alias scp="scp -r"

alias tree='tree -CAFa -I "CVS|*.*.package|.svn|.git|.hg|node_modules|bower_components" --dirsfirst'
alias curlh="curl -sILX GET"

alias zz="exit"
alias xyzzy="echo nothing happens"

# ===== Git Aliases =====
alias g='git'
alias ga='git add .'
alias gap='git add -p'
alias gd='git diff'
alias gds='git diff --staged'
alias gs='git status -sb'
alias gl='git pull'
alias gp='git push'
alias gpf='git push -f'
alias gco='git checkout'
alias gcob='git checkout -b'
alias gundo='git reset --soft HEAD~1'
alias gclean='git clean -xdf'
alias gg='git log --oneline --graph --decorate'

# ===== Docker =====
alias d='docker'
alias dc='docker-compose'
alias dps='docker ps'
alias di='docker images'
alias dclean='docker system prune -af'

# ===== Kubernetes =====
alias k='kubectl'
alias kgp='kubectl get pods'
alias kgd='kubectl get deployments'
alias kgs='kubectl get svc'
alias kl='kubectl logs -f'

# ===== Python =====
alias py="python3"
alias pv='python -m venv .venv'
alias psa='source .venv/bin/activate'
alias pd='deactivate'

# ===== Poetry =====
alias p='poetry'
alias pa='poetry add'
alias pad='poetry add --group dev'
alias pi='poetry install'
alias psh='poetry shell'

# ===== System/Editor =====
alias neogit='nvim +Neogit'
alias vimc='nvim ~/.config/nvim/init.lua'
alias nvrc='nvim ~/.config/nvim'
alias ll='eza -lh --icons=always --group-directories-first'
alias la='eza -lha --icons=always --group-directories-first'
alias lt='eza --tree --level=2 --icons'

alias reload='source ~/.bashrc'
alias src='source ~/.bashrc'

# ===== eza Theme Auto-Switch =====
case "$COLORFGBG" in
*light*) export EZA_THEME="catppuccin-latte" ;;
*) export EZA_THEME="catppuccin-mocha" ;;
esac

# ===== Custom Functions =====
l() {
  ls -gGAhF --color=always "$@" |
    sed -e 's/--x/1/g;s/-w-/2/g;s/-wx/3/g;s/r--/4/g;s/r-x/5/g;s/rw-/6/g;s/rwx/7/g;s/---/0/g;s/rwt/7/g' |
    sed 's/^\(....\) [[:digit:]]/\1 /'
}

y() {
  local tmp cwd
  tmp=$(mktemp -t "yazi-cwd.XXXXXX")
  yazi "$@" --cwd-file="$tmp"
  IFS= read -r -d '' cwd <"$tmp"
  [[ -n "$cwd" && "$cwd" != "$PWD" ]] && cd -- "$cwd"
  rm -f "$tmp"
}

# ===== Bash Completion =====
if ! shopt -oq posix; then
  source /usr/share/bash-completion/bash_completion 2>/dev/null
fi

bind 'set show-all-if-ambiguous on'
bind 'set completion-ignore-case on'
bind 'set colored-stats on'
bind 'TAB: menu-complete'
bind 'set page-completions off'
bind 'set completion-query-items 0'
bind 'set colored-completion-prefix on'

# Load custom completions
if [ -d ~/.bash_completion.d ]; then
  for file in ~/.bash_completion.d/*.bash; do
    source "$file"
  done
fi

# ===== Starship Prompt =====
export STARSHIP_CONFIG="$HOME/.config/starship/starship.toml"
eval "$(starship init bash)"

# ===== zoxide =====
eval "$(zoxide init bash)"

# ===== FZF Theme =====
source ~/.config/fzf/themes/catppuccin-fzf-mocha.sh 2>/dev/null
